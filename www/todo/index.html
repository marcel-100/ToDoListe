<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="styles.css" type="text/css" />
  <script type="text/javascript">

    function initXmlRequests() {
      var xmlHttpReq = false;
      var self = this;
      // Mozilla/Safari
      if (window.XMLHttpRequest) {
        self.xmlHttpReq = new XMLHttpRequest();
      }
      // IE
      else if (window.ActiveXObject) {
        self.xmlHttpReq = new ActiveXObject("Microsoft.XMLHTTP");
      }
      self.xmlHttpReq.open('POST', 'http://' + window.location.host + '/cgi-bin/todohandler', false);
      self.xmlHttpReq.setRequestHeader('Content-Type',
        'application/x-www-form-urlencoded');
      self.xmlHttpReq.onreadystatechange = function () {
        if (self.xmlHttpReq.readyState == 4) {
          updatepage(self.xmlHttpReq.responseText);
        }
      }
    }

    function addToTodolist() {

      initXmlRequests();

      var word = document.getElementById('content').value;

      if (word === "") {
        alert("Bitte einen Text eingeben.")
      } else {

        qstr = 'content=' + escape(word);  // NOTE: no '?' before querystring
        qstr = qstr + "&action=add\n"
        self.xmlHttpReq.send(qstr);
        document.getElementById('content').value = '';
        showTodoList();
      }

    }

    function showTodoList() {
      initXmlRequests();
      self.xmlHttpReq.send("action=show\n");
    }

    function clearList() {
      initXmlRequests();
      self.xmlHttpReq.send("action=delete\n");
    }

    function updatepage(str) {

      console.log(str);

      let items;

      try {
        items = JSON.parse(str).items;
      } catch {}

      if (items instanceof Object) {
        const domNode = document.getElementById("result");

        let i = 0;

        domNode.innerHTML = "";

        items.forEach(element => {

          try {
            element = unescape(element);
          } catch (error) { console.error(error); }
          
          domNode.innerHTML += `<li><input type="button" value="×" onclick="deleteItem(${++i});">${element}</li>`
        });
      }
    }

    function deleteItem(id) {
      initXmlRequests();
      self.xmlHttpReq.send("id=" + id + "&action=delete-item&newparam=FooBar\n");
      showTodoList();
    }

    function handleTextInput(e) {
      if (e.keyCode === 13) {
        addToTodolist();
      }
    }

    addEventListener("load", showTodoList);

  </script>
  <title>To-do-Liste in COBOL</title>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>To-do-Liste in COBOL</h1>
    </div>
    <div class="form">
      <input id="content" type="text" text="50" onkeypress="handleTextInput(event);" autofocus>
      <input value="Eintragen" type="button" onclick="addToTodolist();"><br />
      <input value="Liste löschen" type="button" onclick='javascript:clearList()'>
    </div>
    <div>
      <ul id="result"></ul>
    </div>
  </div>
</body>
</html>